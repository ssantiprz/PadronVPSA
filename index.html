<!doctype html>
<html lang="es">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Buscador padrón (mínimo)</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:24px; color:#0f172a; }
  #status { padding:8px 12px; border-radius:10px; background:#f1f5f9; display:inline-block; }
  #status.ok { background:#dcfce7; }
  #status.err { background:#fee2e2; }
  input { padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; width:100%; max-width:520px; margin:12px 0; }
  .item { padding:8px 10px; border:1px dashed #e2e8f0; border-radius:8px; margin:6px 0; cursor:pointer; }
  .card { margin-top:12px; padding:16px; border-radius:12px; background:#0f172a; color:#fff; }
  .muted { color:#64748b; font-size:12px; }
</style>
<body>
  <div id="status">Cargando padrón…</div>
  <div class="muted" id="url"></div>

  <div>
    <input id="q" placeholder="Buscar por nombre o DNI…" autocomplete="off">
  </div>

  <div id="list"></div>
  <div id="result"></div>

<script>
  const CSV_URL = new URL('padron.csv', location.href).href;
  document.getElementById('url').textContent = 'CSV: ' + CSV_URL;

  const els = {
    q: document.getElementById('q'),
    list: document.getElementById('list'),
    result: document.getElementById('result'),
    status: document.getElementById('status'),
  };
  const state = { rows: [], filtered: [], selected: null };

  function setStatus(text, cls='') {
    els.status.className = ''; if (cls) els.status.classList.add(cls);
    els.status.textContent = text;
  }

  function normalize(str=''){ return str.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }
  function onlyDigits(str=''){ return (str.match(/\d+/g)||[]).join(''); }

  function parseCSV(text) {
    text = text.replace(/^\uFEFF/, '');
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
    if (!lines.length) throw new Error('CSV vacío');
    // comma with quotes
    const parseLine = (line) => {
      const out=[]; let cur='', inQ=false;
      for (let i=0;i<line.length;i++){
        const c=line[i];
        if (c==='"'){ if (inQ && line[i+1]==='"'){ cur+='"'; i++; } else { inQ=!inQ; } }
        else if (c===',' && !inQ){ out.push(cur); cur=''; }
        else { cur+=c; }
      }
      out.push(cur); return out;
    };
    const headers = parseLine(lines.shift()).map(h=>h.trim().toLowerCase());
    const need = ['nombre','dni','mesa','orden','escuela'];
    for (const n of need) if (!headers.includes(n)) throw new Error('Falta columna: ' + n + '. Encabezados: ' + headers.join(', '));
    const idx = (k)=> headers.indexOf(k);
    const iNombre=idx('nombre'), iDni=idx('dni'), iMesa=idx('mesa'), iOrden=idx('orden'), iEscuela=idx('escuela');
    return lines.map(l => {
      const cols = parseLine(l);
      const get = (i)=> (cols[i] ?? '').trim();
      const r = { nombre:get(iNombre), dni:get(iDni), mesa:get(iMesa), orden:get(iOrden), escuela:get(iEscuela) };
      r.__k_nombre = normalize(r.nombre);
      r.__k_dni = onlyDigits(r.dni);
      return r;
    });
  }

  function setRows(text){
    state.rows = parseCSV(text);
    setStatus('Datos cargados (' + new Date().toLocaleString() + ')', 'ok');
    applyFilter();
  }

  function renderList(){
    els.list.innerHTML='';
    state.filtered.forEach(r => {
      const d = document.createElement('div');
      d.className='item';
      d.innerHTML = '<b>' + r.nombre + '</b> — DNI ' + r.dni + '<div class="muted">Escuela: ' + r.escuela + ' • Mesa ' + r.mesa + ' · Orden ' + r.orden + '</div>';
      d.onclick = () => select(r);
      els.list.appendChild(d);
    });
  }

  function renderCard(r){
    els.result.innerHTML = '<div class="card"><h3 style="margin:0 0 8px 0;">' + r.nombre + ' — DNI ' + r.dni + '</h3>' +
      '<div><b>Escuela</b>: ' + r.escuela + '</div>' +
      '<div><b>Mesa</b>: ' + r.mesa + ' &nbsp; <b>Orden</b>: ' + r.orden + '</div></div>';
  }

  function select(r){ state.selected=r; renderCard(r); }

  function applyFilter(){
    const q = els.q.value.trim();
    if (!q){ els.list.innerHTML=''; els.result.innerHTML=''; return; }
    const qn = normalize(q), qd = onlyDigits(q);
    let matches = [];
    if (qd.length >= 6) matches = state.rows.filter(r => r.__k_dni.endsWith(qd));
    if (matches.length === 0) matches = state.rows.filter(r => r.__k_nombre.includes(qn));
    state.filtered = matches.slice(0, 100);
    renderList();
    if (state.filtered.length===1) select(state.filtered[0]);
  }

  els.q.addEventListener('input', applyFilter);

  async function loadCSV(){
    try{
      setStatus('Cargando padrón…');
      const attempted = CSV_URL + (CSV_URL.includes('?') ? '&' : '?') + 't=' + Date.now();
      const res = await fetch(attempted, {cache:'no-store'});
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const text = await res.text();
      setRows(text);
    }catch(e){
      setStatus('Error cargando datos: ' + e.message, 'err');
      console.error(e);
    }
  }

  loadCSV();
</script>
</body>
</html>
